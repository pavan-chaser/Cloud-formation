---
- name: VPC Wizard One Setup
  hosts: localhost

  tasks:
  
  - ec2_vpc_net:
      name: "{{ vpc_name }}"
      cidr_block: "{{ vpc_cidr_block }}"
      region: "{{ aws_region }}"
      aws_access_key: "{{ aws_access_key }}"
      aws_secret_key: "{{ aws_secret_key }}"
      state: "present"
    register: my_vpc

  - name: Set VPC ID in variable
    set_fact:
      vpc_id: "{{ my_vpc.vpc.id }}"

  - name: degug vpc name
    debug:
      msg: "{{ my_vpc }}"

  - name: Create Public Subnet
    ec2_vpc_subnet:
      state: "present"
      vpc_id: "{{ vpc_id }}"
      cidr: "{{ public_subnet_1_cidr }}"
      az: "{{ aws_region }}a"
      region: "{{ aws_region }}"
      aws_access_key: "{{ aws_access_key }}"
      aws_secret_key: "{{ aws_secret_key }}"
      resource_tags:
        Name: "Public Subnet"
    register: my_public_subnet

  - name: Set Public Subnet ID in variable
    set_fact:
      public_subnet_id: "{{ my_public_subnet.subnet.id }}"
    
  - name: degug Public Subnet name
    debug:
      msg: "{{ my_public_subnet }}"

  - name: Create Internet Gateway for VPC
    ec2_vpc_igw:
      vpc_id: "{{ vpc_id }}"
      region: "{{ aws_region }}"
      aws_access_key: "{{ aws_access_key }}"
      aws_secret_key: "{{ aws_secret_key }}"
      state: "present"
    register: my_vpc_igw
    
  - name: Set Internet Gateway ID in variable
    set_fact:
      igw_id: "{{ my_vpc_igw.gateway_id }}"

  - name: degug IGW name
    debug:
      msg: "{{ my_vpc_igw }}"

  - name: Set up public subnet route table
    ec2_vpc_route_table:
      vpc_id: "{{ vpc_id }}"
      region: "{{ aws_region }}"
      aws_access_key: "{{ aws_access_key }}"
      aws_secret_key: "{{ aws_secret_key }}"
      tags:
        Name: "Public"
      subnets:
        - "{{ public_subnet_id }}"
      routes:
        - dest: "0.0.0.0/0"
          gateway_id: "{{ igw_id }}"
    register: my_route_table

  - name: degug IGW name
    debug:
      msg: "{{ my_route_table }}"